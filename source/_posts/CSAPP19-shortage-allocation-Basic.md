---
title: 'CSAPP19: shortage allocation:Basic'
date: 2020-02-07 20:25:11
tags:
    - 课程
    - 笔记
categories: 
    - CSAPP
    - shortage allocation
    - Basic
---
<!-- TOC -->

- [1. 动态分配内存（堆）](#1-动态分配内存堆)
    - [1.1 回收方式](#11-回收方式)
    - [1.2 衡量标准](#12-衡量标准)
- [2. 分配中的细节](#2-分配中的细节)
    - [2.1 怎么free多少内存只靠指针](#21-怎么free多少内存只靠指针)
    - [2.2 怎么跟踪这些没分配的内存](#22-怎么跟踪这些没分配的内存)
    - [2.3 怎么应对格外的空间（字节对齐造成的浪费）](#23-怎么应对格外的空间字节对齐造成的浪费)
    - [2.4 怎么找空块去分配](#24-怎么找空块去分配)
    - [2.5 如何合理释放已经分配的块](#25-如何合理释放已经分配的块)

<!-- /TOC -->

# 1. 动态分配内存（堆）

## 1.1 回收方式
* c 显示分配 显示回收 
* java等 显示分配 隐式回收

## 1.2 衡量标准
* 吞吐量：每秒能调用多少次
* 内存利用率：就是分配中使用的有效内存
    影响因素
    * 内部碎片：字节对齐 需要标记等
    * 外部碎片： 如下图
    ![](/CSAPP19-shortage-allocation-Basic/1.png)
    
# 2. 分配中的细节

## 2.1 怎么free多少内存只靠指针
通过堆的header标识
## 2.2 怎么跟踪这些没分配的内存
4种方法
![](/CSAPP19-shortage-allocation-Basic/2.png)


***以下以第一种方法讲解后续问题***

## 2.3 怎么应对格外的空间（字节对齐造成的浪费）
如下图
![](/CSAPP19-shortage-allocation-Basic/3.png)
***无可避免，但是可以节省***

因为size的大小总是8的倍数或者16的 所以要存一些东西的时候回出现空的

也因为size的大小总是8的倍数或者16的 所以不需要一个额外的word来存状态 只需存在size的 最后3位bit里面的一位 因为他们一直是0

## 2.4 怎么找空块去分配
* first fit：从头开始找（线性时间 terrible)
* Next fit: 从上次找结束的地方开始够放置的就行 （也并不好）
* best fit：找到最好的块放置
* good fit：first fit + best fit 再开始的地方找一些最合适的块存放

## 2.5 如何合理释放已经分配的块

* 直接释放 （置位释放）
![](/CSAPP19-shortage-allocation-Basic/4.png)
waste too much  内存会逐渐崩溃

* 连接的下一个释放
![](/CSAPP19-shortage-allocation-Basic/5.png)
但是处理不了上面一块

* 通过添加foot 连接的上下释放
![](/CSAPP19-shortage-allocation-Basic/6.png)
但是这样有点太浪费了，因为对于分配过的内存是不需要合并的。
可以通过利用size那最后3位都是0，拿出一位来标记上面是否是已分配的块，这样不是的话它肯定有foot， 一切一样是的话就不做操作。（tricks)

